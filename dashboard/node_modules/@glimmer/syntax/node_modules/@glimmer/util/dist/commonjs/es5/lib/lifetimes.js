"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isDrop = isDrop;
exports.associate = associate;
exports.associateDestructor = associateDestructor;
exports.peekAssociated = peekAssociated;
exports.takeAssociated = takeAssociated;
exports.willDestroyAssociated = willDestroyAssociated;
exports.didDestroyAssociated = didDestroyAssociated;
exports.destructor = destructor;
exports.snapshot = snapshot;
exports.debugDropTree = debugDropTree;
exports.printDropTree = printDropTree;
exports.printDrop = printDrop;
exports.ListContentsDestructor = exports.DESTRUCTORS = exports.CHILDREN = exports.DID_DROP = exports.WILL_DROP = exports.LINKED = void 0;

var _destroy = require("./destroy");

var _platformUtils = require("./platform-utils");

function _defineProperties(target, props) {
  for (var i = 0; i < props.length; i++) {
    var descriptor = props[i];
    descriptor.enumerable = descriptor.enumerable || false;
    descriptor.configurable = true;
    if ("value" in descriptor) descriptor.writable = true;
    Object.defineProperty(target, descriptor.key, descriptor);
  }
}

function _createClass(Constructor, protoProps, staticProps) {
  if (protoProps) _defineProperties(Constructor.prototype, protoProps);
  if (staticProps) _defineProperties(Constructor, staticProps);
  return Constructor;
}

var LINKED = new WeakMap();
exports.LINKED = LINKED;
var WILL_DROP = (0, _platformUtils.symbol)('WILL_DROP');
exports.WILL_DROP = WILL_DROP;
var DID_DROP = (0, _platformUtils.symbol)('DID_DROP');
exports.DID_DROP = DID_DROP;
var CHILDREN = (0, _platformUtils.symbol)('CHILDREN');
exports.CHILDREN = CHILDREN;
var DESTRUCTORS = new WeakMap();
exports.DESTRUCTORS = DESTRUCTORS;

function isDrop(value) {
  if (value === null || typeof value !== 'object') return false;
  return value[DID_DROP] !== undefined;
}

function associate(parent, child) {
  associateDestructor(parent, destructor(child));
}

function associateDestructor(parent, child) {
  var associated = LINKED.get(parent);

  if (!associated) {
    associated = new Set();
    LINKED.set(parent, associated);
  }

  associated.add(child);
}

function peekAssociated(parent) {
  return LINKED.get(parent) || null;
}

function takeAssociated(parent) {
  var linked = LINKED.get(parent);

  if (linked && linked.size > 0) {
    LINKED["delete"](parent);
    return linked;
  } else {
    return null;
  }
}

function willDestroyAssociated(parent) {
  var associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(function (item) {
      item[WILL_DROP]();
    });
  }
}

function didDestroyAssociated(parent) {
  var associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(function (item) {
      item[DID_DROP]();
      associated["delete"](item);
    });
  }
}

function destructor(value) {
  var d = DESTRUCTORS.get(value);

  if (!d) {
    if ((0, _destroy.isDestroyable)(value)) {
      d = new DestroyableDestructor(value);
    } else if ((0, _destroy.isStringDestroyable)(value)) {
      d = new StringDestroyableDestructor(value);
    } else {
      d = new SimpleDestructor(value);
    }

    DESTRUCTORS.set(value, d);
  }

  return d;
}

function snapshot(values) {
  return new SnapshotDestructor(values);
}

var SnapshotDestructor =
/*#__PURE__*/
function () {
  function SnapshotDestructor(destructors) {
    this.destructors = destructors;
  }

  var _proto = SnapshotDestructor.prototype;

  _proto[WILL_DROP] = function () {
    this.destructors.forEach(function (item) {
      return item[WILL_DROP]();
    });
  };

  _proto[DID_DROP] = function () {
    this.destructors.forEach(function (item) {
      return item[DID_DROP]();
    });
  };

  _proto.toString = function toString() {
    return 'SnapshotDestructor';
  };

  _createClass(SnapshotDestructor, [{
    key: CHILDREN,
    get: function get() {
      return this.destructors;
    }
  }]);

  return SnapshotDestructor;
}();

var DestroyableDestructor =
/*#__PURE__*/
function () {
  function DestroyableDestructor(inner) {
    this.inner = inner;
  }

  var _proto2 = DestroyableDestructor.prototype;

  _proto2[WILL_DROP] = function () {
    willDestroyAssociated(this.inner);
  };

  _proto2[DID_DROP] = function () {
    this.inner[_destroy.DESTROY]();

    didDestroyAssociated(this.inner);
  };

  _proto2.toString = function toString() {
    return 'DestroyableDestructor';
  };

  _createClass(DestroyableDestructor, [{
    key: CHILDREN,
    get: function get() {
      return LINKED.get(this.inner) || [];
    }
  }]);

  return DestroyableDestructor;
}();

var StringDestroyableDestructor =
/*#__PURE__*/
function () {
  function StringDestroyableDestructor(inner) {
    this.inner = inner;
  }

  var _proto3 = StringDestroyableDestructor.prototype;

  _proto3[WILL_DROP] = function () {
    if (typeof this.inner.willDestroy === 'function') {
      this.inner.willDestroy();
    }

    willDestroyAssociated(this.inner);
  };

  _proto3[DID_DROP] = function () {
    this.inner.destroy();
    didDestroyAssociated(this.inner);
  };

  _proto3.toString = function toString() {
    return 'StringDestroyableDestructor';
  };

  _createClass(StringDestroyableDestructor, [{
    key: CHILDREN,
    get: function get() {
      return LINKED.get(this.inner) || [];
    }
  }]);

  return StringDestroyableDestructor;
}();

var SimpleDestructor =
/*#__PURE__*/
function () {
  function SimpleDestructor(inner) {
    this.inner = inner;
  }

  var _proto4 = SimpleDestructor.prototype;

  _proto4[WILL_DROP] = function () {
    willDestroyAssociated(this.inner);
  };

  _proto4[DID_DROP] = function () {
    didDestroyAssociated(this.inner);
  };

  _proto4.toString = function toString() {
    return 'SimpleDestructor';
  };

  _createClass(SimpleDestructor, [{
    key: CHILDREN,
    get: function get() {
      return LINKED.get(this.inner) || [];
    }
  }]);

  return SimpleDestructor;
}();

var ListContentsDestructor =
/*#__PURE__*/
function () {
  function ListContentsDestructor(inner) {
    this.inner = inner;
  }

  var _proto5 = ListContentsDestructor.prototype;

  _proto5[WILL_DROP] = function () {
    this.inner.forEachNode(function (d) {
      return destructor(d)[WILL_DROP]();
    });
  };

  _proto5[DID_DROP] = function () {
    this.inner.forEachNode(function (d) {
      return destructor(d)[DID_DROP]();
    });
  };

  _proto5.toString = function toString() {
    return 'ListContentsDestructor';
  };

  _createClass(ListContentsDestructor, [{
    key: CHILDREN,
    get: function get() {
      var out = [];
      this.inner.forEachNode(function (d) {
        return out.push.apply(out, destructor(d)[CHILDREN]);
      });
      return out;
    }
  }]);

  return ListContentsDestructor;
}();

exports.ListContentsDestructor = ListContentsDestructor;

function debugDropTree(inner) {
  var hasDrop = isDrop(inner);
  var rawChildren = LINKED.get(inner) || null;
  var children = null;

  if (rawChildren) {
    children = [];

    for (var _iterator = rawChildren, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
      var _ref;

      if (_isArray) {
        if (_i >= _iterator.length) break;
        _ref = _iterator[_i++];
      } else {
        _i = _iterator.next();
        if (_i.done) break;
        _ref = _i.value;
      }

      var child = _ref;
      children.push(debugDropTree(child));
    }
  }

  var obj = Object.create(null);
  obj.inner = inner;

  if (children) {
    obj.children = children;
  }

  obj.hasDrop = hasDrop;
  return obj;
}

function printDropTree(inner) {
  printDrop(destructor(inner));
}

function printDrop(inner) {
  console.group(String(inner));
  console.log(inner);
  var children = inner[CHILDREN] || null;

  if (children) {
    for (var _iterator2 = children, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
      var _ref2;

      if (_isArray2) {
        if (_i2 >= _iterator2.length) break;
        _ref2 = _iterator2[_i2++];
      } else {
        _i2 = _iterator2.next();
        if (_i2.done) break;
        _ref2 = _i2.value;
      }

      var child = _ref2;
      printDrop(child);
    }
  }

  console.groupEnd();
}

if (false
/* LOCAL_DEBUG */
&& typeof window !== 'undefined') {
  window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBWUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVPLElBQU0sTUFBTSxHQUErQixJQUEzQyxPQUEyQyxFQUEzQzs7QUFDQSxJQUFNLFNBQVMsR0FBbUIsMkJBQWxDLFdBQWtDLENBQWxDOztBQUNBLElBQU0sUUFBUSxHQUFrQiwyQkFBaEMsVUFBZ0MsQ0FBaEM7O0FBQ0EsSUFBTSxRQUFRLEdBQW1CLDJCQUFqQyxVQUFpQyxDQUFqQzs7QUFDQSxJQUFNLFdBQVcsR0FBRyxJQUFwQixPQUFvQixFQUFwQjs7O0FBRUQsU0FBQSxNQUFBLENBQUEsS0FBQSxFQUErQjtBQUNuQyxNQUFJLEtBQUssS0FBTCxJQUFBLElBQWtCLE9BQUEsS0FBQSxLQUF0QixRQUFBLEVBQWlELE9BQUEsS0FBQTtBQUNqRCxTQUFRLEtBQWMsQ0FBZCxRQUFjLENBQWQsS0FBUixTQUFBO0FBQ0Q7O0FBRUssU0FBQSxTQUFBLENBQUEsTUFBQSxFQUFBLEtBQUEsRUFBaUQ7QUFDckQsRUFBQSxtQkFBbUIsQ0FBQSxNQUFBLEVBQVMsVUFBVSxDQUF0QyxLQUFzQyxDQUFuQixDQUFuQjtBQUNEOztBQUVLLFNBQUEsbUJBQUEsQ0FBQSxNQUFBLEVBQUEsS0FBQSxFQUF5RDtBQUM3RCxNQUFJLFVBQVUsR0FBRyxNQUFNLENBQU4sR0FBQSxDQUFqQixNQUFpQixDQUFqQjs7QUFFQSxNQUFJLENBQUosVUFBQSxFQUFpQjtBQUNmLElBQUEsVUFBVSxHQUFHLElBQWIsR0FBYSxFQUFiO0FBQ0EsSUFBQSxNQUFNLENBQU4sR0FBQSxDQUFBLE1BQUEsRUFBQSxVQUFBO0FBQ0Q7O0FBRUQsRUFBQSxVQUFVLENBQVYsR0FBQSxDQUFBLEtBQUE7QUFDRDs7QUFFSyxTQUFBLGNBQUEsQ0FBQSxNQUFBLEVBQXVDO0FBQzNDLFNBQU8s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U3RyaW5nRGVzdHJveWFibGUsIERFU1RST1kgfSBmcm9tICcuL2Rlc3Ryb3knO1xuaW1wb3J0IHtcbiAgT3B0aW9uLFxuICBTeW1ib2xEZXN0cm95YWJsZSxcbiAgRGVzdHJveWFibGUsXG4gIERyb3AsXG4gIFdpbGxEcm9wU3ltYm9sLFxuICBEaWREcm9wU3ltYm9sLFxuICBDaGlsZHJlblN5bWJvbCxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBMaW5rZWRMaXN0LCBMaW5rZWRMaXN0Tm9kZSB9IGZyb20gJy4vbGlzdC11dGlscyc7XG5pbXBvcnQgeyBMT0NBTF9ERUJVRyB9IGZyb20gJ0BnbGltbWVyL2xvY2FsLWRlYnVnLWZsYWdzJztcbmltcG9ydCB7IHN5bWJvbCB9IGZyb20gJy4vcGxhdGZvcm0tdXRpbHMnO1xuXG5leHBvcnQgY29uc3QgTElOS0VEOiBXZWFrTWFwPG9iamVjdCwgU2V0PERyb3A+PiA9IG5ldyBXZWFrTWFwKCk7XG5leHBvcnQgY29uc3QgV0lMTF9EUk9QOiBXaWxsRHJvcFN5bWJvbCA9IHN5bWJvbCgnV0lMTF9EUk9QJyk7XG5leHBvcnQgY29uc3QgRElEX0RST1A6IERpZERyb3BTeW1ib2wgPSBzeW1ib2woJ0RJRF9EUk9QJyk7XG5leHBvcnQgY29uc3QgQ0hJTERSRU46IENoaWxkcmVuU3ltYm9sID0gc3ltYm9sKCdDSElMRFJFTicpO1xuZXhwb3J0IGNvbnN0IERFU1RSVUNUT1JTID0gbmV3IFdlYWtNYXAoKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzRHJvcCh2YWx1ZTogdW5rbm93bik6IHZhbHVlIGlzIERyb3Age1xuICBpZiAodmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlO1xuICByZXR1cm4gKHZhbHVlIGFzIERyb3ApW0RJRF9EUk9QXSAhPT0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXNzb2NpYXRlKHBhcmVudDogb2JqZWN0LCBjaGlsZDogb2JqZWN0KSB7XG4gIGFzc29jaWF0ZURlc3RydWN0b3IocGFyZW50LCBkZXN0cnVjdG9yKGNoaWxkKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhc3NvY2lhdGVEZXN0cnVjdG9yKHBhcmVudDogb2JqZWN0LCBjaGlsZDogRHJvcCk6IHZvaWQge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoIWFzc29jaWF0ZWQpIHtcbiAgICBhc3NvY2lhdGVkID0gbmV3IFNldCgpO1xuICAgIExJTktFRC5zZXQocGFyZW50LCBhc3NvY2lhdGVkKTtcbiAgfVxuXG4gIGFzc29jaWF0ZWQuYWRkKGNoaWxkKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlZWtBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KTogT3B0aW9uPFNldDxEcm9wPj4ge1xuICByZXR1cm4gTElOS0VELmdldChwYXJlbnQpIHx8IG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0YWtlQXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCk6IE9wdGlvbjxTZXQ8RHJvcD4+IHtcbiAgbGV0IGxpbmtlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAobGlua2VkICYmIGxpbmtlZC5zaXplID4gMCkge1xuICAgIExJTktFRC5kZWxldGUocGFyZW50KTtcbiAgICByZXR1cm4gbGlua2VkO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3aWxsRGVzdHJveUFzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKGFzc29jaWF0ZWQpIHtcbiAgICBhc3NvY2lhdGVkLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtW1dJTExfRFJPUF0oKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlkRGVzdHJveUFzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKGFzc29jaWF0ZWQpIHtcbiAgICBhc3NvY2lhdGVkLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtW0RJRF9EUk9QXSgpO1xuICAgICAgYXNzb2NpYXRlZCEuZGVsZXRlKGl0ZW0pO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cnVjdG9yKHZhbHVlOiBvYmplY3QpOiBEcm9wIHtcbiAgbGV0IGQgPSBERVNUUlVDVE9SUy5nZXQodmFsdWUpO1xuXG4gIGlmICghZCkge1xuICAgIGlmIChpc0Rlc3Ryb3lhYmxlKHZhbHVlKSkge1xuICAgICAgZCA9IG5ldyBEZXN0cm95YWJsZURlc3RydWN0b3IodmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoaXNTdHJpbmdEZXN0cm95YWJsZSh2YWx1ZSkpIHtcbiAgICAgIGQgPSBuZXcgU3RyaW5nRGVzdHJveWFibGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZCA9IG5ldyBTaW1wbGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9XG5cbiAgICBERVNUUlVDVE9SUy5zZXQodmFsdWUsIGQpO1xuICB9XG5cbiAgcmV0dXJuIGQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzbmFwc2hvdCh2YWx1ZXM6IFNldDxEcm9wPik6IERyb3Age1xuICByZXR1cm4gbmV3IFNuYXBzaG90RGVzdHJ1Y3Rvcih2YWx1ZXMpO1xufVxuXG5jbGFzcyBTbmFwc2hvdERlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkZXN0cnVjdG9yczogU2V0PERyb3A+KSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHRoaXMuZGVzdHJ1Y3RvcnMuZm9yRWFjaChpdGVtID0+IGl0ZW1bV0lMTF9EUk9QXSgpKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5mb3JFYWNoKGl0ZW0gPT4gaXRlbVtESURfRFJPUF0oKSk7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIHRoaXMuZGVzdHJ1Y3RvcnM7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ1NuYXBzaG90RGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuY2xhc3MgRGVzdHJveWFibGVEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IFN5bWJvbERlc3Ryb3lhYmxlKSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHdpbGxEZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lcltERVNUUk9ZXSgpO1xuICAgIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdEZXN0cm95YWJsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIFN0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBEZXN0cm95YWJsZSkge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMuaW5uZXIud2lsbERlc3Ryb3kgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuaW5uZXIud2lsbERlc3Ryb3koKTtcbiAgICB9XG4gICAgd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyLmRlc3Ryb3koKTtcbiAgICBkaWREZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU3RyaW5nRGVzdHJveWFibGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBTaW1wbGVEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IG9iamVjdCkge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB3aWxsRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTaW1wbGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTGlzdENvbnRlbnRzRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBMaW5rZWRMaXN0PExpbmtlZExpc3ROb2RlPikge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyLmZvckVhY2hOb2RlKGQgPT4gZGVzdHJ1Y3RvcihkKVtXSUxMX0RST1BdKCkpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyLmZvckVhY2hOb2RlKGQgPT4gZGVzdHJ1Y3RvcihkKVtESURfRFJPUF0oKSk7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgbGV0IG91dDogRHJvcFtdID0gW107XG4gICAgdGhpcy5pbm5lci5mb3JFYWNoTm9kZShkID0+IG91dC5wdXNoKC4uLmRlc3RydWN0b3IoZClbQ0hJTERSRU5dKSk7XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnTGlzdENvbnRlbnRzRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWJ1Z05vZGUge1xuICBpbm5lcjogb2JqZWN0O1xuICBjaGlsZHJlbjogRGVidWdOb2RlW10gfCBudWxsO1xuICBoYXNEcm9wOiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVidWdEcm9wVHJlZShpbm5lcjogb2JqZWN0KTogRGVidWdOb2RlIHtcbiAgbGV0IGhhc0Ryb3AgPSBpc0Ryb3AoaW5uZXIpO1xuICBsZXQgcmF3Q2hpbGRyZW4gPSBMSU5LRUQuZ2V0KGlubmVyKSB8fCBudWxsO1xuICBsZXQgY2hpbGRyZW46IERlYnVnTm9kZVtdIHwgbnVsbCA9IG51bGw7XG5cbiAgaWYgKHJhd0NoaWxkcmVuKSB7XG4gICAgY2hpbGRyZW4gPSBbXTtcbiAgICBmb3IgKGxldCBjaGlsZCBvZiByYXdDaGlsZHJlbikge1xuICAgICAgY2hpbGRyZW4ucHVzaChkZWJ1Z0Ryb3BUcmVlKGNoaWxkKSk7XG4gICAgfVxuICB9XG5cbiAgbGV0IG9iaiA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gIG9iai5pbm5lciA9IGlubmVyO1xuICBpZiAoY2hpbGRyZW4pIHtcbiAgICBvYmouY2hpbGRyZW4gPSBjaGlsZHJlbjtcbiAgfVxuICBvYmouaGFzRHJvcCA9IGhhc0Ryb3A7XG4gIHJldHVybiBvYmo7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludERyb3BUcmVlKGlubmVyOiBvYmplY3QpIHtcbiAgcHJpbnREcm9wKGRlc3RydWN0b3IoaW5uZXIpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByaW50RHJvcChpbm5lcjogRHJvcCkge1xuICBjb25zb2xlLmdyb3VwKFN0cmluZyhpbm5lcikpO1xuXG4gIGNvbnNvbGUubG9nKGlubmVyKTtcblxuICBsZXQgY2hpbGRyZW4gPSBpbm5lcltDSElMRFJFTl0gfHwgbnVsbDtcbiAgaWYgKGNoaWxkcmVuKSB7XG4gICAgZm9yIChsZXQgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgIHByaW50RHJvcChjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgY29uc29sZS5ncm91cEVuZCgpO1xufVxuXG5pZiAoTE9DQUxfREVCVUcgJiYgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgKHdpbmRvdyBhcyBhbnkpLlBSSU5UX0RST1AgPSBwcmludERyb3BUcmVlO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==