import { isDestroyable, isStringDestroyable, DESTROY } from './destroy';
import { symbol } from './platform-utils';
export const LINKED = new WeakMap();
export const WILL_DROP = symbol('WILL_DROP');
export const DID_DROP = symbol('DID_DROP');
export const CHILDREN = symbol('CHILDREN');
export const DESTRUCTORS = new WeakMap();
export function isDrop(value) {
  if (value === null || typeof value !== 'object') return false;
  return value[DID_DROP] !== undefined;
}
export function associate(parent, child) {
  associateDestructor(parent, destructor(child));
}
export function associateDestructor(parent, child) {
  let associated = LINKED.get(parent);

  if (!associated) {
    associated = new Set();
    LINKED.set(parent, associated);
  }

  associated.add(child);
}
export function peekAssociated(parent) {
  return LINKED.get(parent) || null;
}
export function takeAssociated(parent) {
  let linked = LINKED.get(parent);

  if (linked && linked.size > 0) {
    LINKED.delete(parent);
    return linked;
  } else {
    return null;
  }
}
export function willDestroyAssociated(parent) {
  let associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(item => {
      item[WILL_DROP]();
    });
  }
}
export function didDestroyAssociated(parent) {
  let associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(item => {
      item[DID_DROP]();
      associated.delete(item);
    });
  }
}
export function destructor(value) {
  let d = DESTRUCTORS.get(value);

  if (!d) {
    if (isDestroyable(value)) {
      d = new DestroyableDestructor(value);
    } else if (isStringDestroyable(value)) {
      d = new StringDestroyableDestructor(value);
    } else {
      d = new SimpleDestructor(value);
    }

    DESTRUCTORS.set(value, d);
  }

  return d;
}
export function snapshot(values) {
  return new SnapshotDestructor(values);
}

class SnapshotDestructor {
  constructor(destructors) {
    this.destructors = destructors;
  }

  [WILL_DROP]() {
    this.destructors.forEach(item => item[WILL_DROP]());
  }

  [DID_DROP]() {
    this.destructors.forEach(item => item[DID_DROP]());
  }

  get [CHILDREN]() {
    return this.destructors;
  }

  toString() {
    return 'SnapshotDestructor';
  }

}

class DestroyableDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    willDestroyAssociated(this.inner);
  }

  [DID_DROP]() {
    this.inner[DESTROY]();
    didDestroyAssociated(this.inner);
  }

  get [CHILDREN]() {
    return LINKED.get(this.inner) || [];
  }

  toString() {
    return 'DestroyableDestructor';
  }

}

class StringDestroyableDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    if (typeof this.inner.willDestroy === 'function') {
      this.inner.willDestroy();
    }

    willDestroyAssociated(this.inner);
  }

  [DID_DROP]() {
    this.inner.destroy();
    didDestroyAssociated(this.inner);
  }

  get [CHILDREN]() {
    return LINKED.get(this.inner) || [];
  }

  toString() {
    return 'StringDestroyableDestructor';
  }

}

class SimpleDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    willDestroyAssociated(this.inner);
  }

  [DID_DROP]() {
    didDestroyAssociated(this.inner);
  }

  get [CHILDREN]() {
    return LINKED.get(this.inner) || [];
  }

  toString() {
    return 'SimpleDestructor';
  }

}

export class ListContentsDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    this.inner.forEachNode(d => destructor(d)[WILL_DROP]());
  }

  [DID_DROP]() {
    this.inner.forEachNode(d => destructor(d)[DID_DROP]());
  }

  get [CHILDREN]() {
    let out = [];
    this.inner.forEachNode(d => out.push(...destructor(d)[CHILDREN]));
    return out;
  }

  toString() {
    return 'ListContentsDestructor';
  }

}
export function debugDropTree(inner) {
  let hasDrop = isDrop(inner);
  let rawChildren = LINKED.get(inner) || null;
  let children = null;

  if (rawChildren) {
    children = [];

    for (let child of rawChildren) {
      children.push(debugDropTree(child));
    }
  }

  let obj = Object.create(null);
  obj.inner = inner;

  if (children) {
    obj.children = children;
  }

  obj.hasDrop = hasDrop;
  return obj;
}
export function printDropTree(inner) {
  printDrop(destructor(inner));
}
export function printDrop(inner) {
  console.group(String(inner));
  console.log(inner);
  let children = inner[CHILDREN] || null;

  if (children) {
    for (let child of children) {
      printDrop(child);
    }
  }

  console.groupEnd();
}

if (false
/* LOCAL_DEBUG */
&& typeof window !== 'undefined') {
  window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTLGFBQVQsRUFBd0IsbUJBQXhCLEVBQTZDLE9BQTdDLFFBQTRELFdBQTVEO0FBWUEsU0FBUyxNQUFULFFBQXVCLGtCQUF2QjtBQUVBLE9BQU8sTUFBTSxNQUFNLEdBQStCLElBQUksT0FBSixFQUEzQztBQUNQLE9BQU8sTUFBTSxTQUFTLEdBQW1CLE1BQU0sQ0FBQyxXQUFELENBQXhDO0FBQ1AsT0FBTyxNQUFNLFFBQVEsR0FBa0IsTUFBTSxDQUFDLFVBQUQsQ0FBdEM7QUFDUCxPQUFPLE1BQU0sUUFBUSxHQUFtQixNQUFNLENBQUMsVUFBRCxDQUF2QztBQUNQLE9BQU8sTUFBTSxXQUFXLEdBQUcsSUFBSSxPQUFKLEVBQXBCO0FBRVAsT0FBTSxTQUFVLE1BQVYsQ0FBaUIsS0FBakIsRUFBK0I7QUFDbkMsTUFBSSxLQUFLLEtBQUssSUFBVixJQUFrQixPQUFPLEtBQVAsS0FBaUIsUUFBdkMsRUFBaUQsT0FBTyxLQUFQO0FBQ2pELFNBQVEsS0FBYyxDQUFDLFFBQUQsQ0FBZCxLQUE2QixTQUFyQztBQUNEO0FBRUQsT0FBTSxTQUFVLFNBQVYsQ0FBb0IsTUFBcEIsRUFBb0MsS0FBcEMsRUFBaUQ7QUFDckQsRUFBQSxtQkFBbUIsQ0FBQyxNQUFELEVBQVMsVUFBVSxDQUFDLEtBQUQsQ0FBbkIsQ0FBbkI7QUFDRDtBQUVELE9BQU0sU0FBVSxtQkFBVixDQUE4QixNQUE5QixFQUE4QyxLQUE5QyxFQUF5RDtBQUM3RCxNQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsR0FBUCxDQUFXLE1BQVgsQ0FBakI7O0FBRUEsTUFBSSxDQUFDLFVBQUwsRUFBaUI7QUFDZixJQUFBLFVBQVUsR0FBRyxJQUFJLEdBQUosRUFBYjtBQUNBLElBQUEsTUFBTSxDQUFDLEdBQVAsQ0FBVyxNQUFYLEVBQW1CLFVBQW5CO0FBQ0Q7O0FBRUQs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WSB9IGZyb20gJy4vZGVzdHJveSc7XG5pbXBvcnQge1xuICBPcHRpb24sXG4gIFN5bWJvbERlc3Ryb3lhYmxlLFxuICBEZXN0cm95YWJsZSxcbiAgRHJvcCxcbiAgV2lsbERyb3BTeW1ib2wsXG4gIERpZERyb3BTeW1ib2wsXG4gIENoaWxkcmVuU3ltYm9sLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IExpbmtlZExpc3QsIExpbmtlZExpc3ROb2RlIH0gZnJvbSAnLi9saXN0LXV0aWxzJztcbmltcG9ydCB7IExPQ0FMX0RFQlVHIH0gZnJvbSAnQGdsaW1tZXIvbG9jYWwtZGVidWctZmxhZ3MnO1xuaW1wb3J0IHsgc3ltYm9sIH0gZnJvbSAnLi9wbGF0Zm9ybS11dGlscyc7XG5cbmV4cG9ydCBjb25zdCBMSU5LRUQ6IFdlYWtNYXA8b2JqZWN0LCBTZXQ8RHJvcD4+ID0gbmV3IFdlYWtNYXAoKTtcbmV4cG9ydCBjb25zdCBXSUxMX0RST1A6IFdpbGxEcm9wU3ltYm9sID0gc3ltYm9sKCdXSUxMX0RST1AnKTtcbmV4cG9ydCBjb25zdCBESURfRFJPUDogRGlkRHJvcFN5bWJvbCA9IHN5bWJvbCgnRElEX0RST1AnKTtcbmV4cG9ydCBjb25zdCBDSElMRFJFTjogQ2hpbGRyZW5TeW1ib2wgPSBzeW1ib2woJ0NISUxEUkVOJyk7XG5leHBvcnQgY29uc3QgREVTVFJVQ1RPUlMgPSBuZXcgV2Vha01hcCgpO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNEcm9wKHZhbHVlOiB1bmtub3duKTogdmFsdWUgaXMgRHJvcCB7XG4gIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgIT09ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7XG4gIHJldHVybiAodmFsdWUgYXMgRHJvcClbRElEX0RST1BdICE9PSB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhc3NvY2lhdGUocGFyZW50OiBvYmplY3QsIGNoaWxkOiBvYmplY3QpIHtcbiAgYXNzb2NpYXRlRGVzdHJ1Y3RvcihwYXJlbnQsIGRlc3RydWN0b3IoY2hpbGQpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc29jaWF0ZURlc3RydWN0b3IocGFyZW50OiBvYmplY3QsIGNoaWxkOiBEcm9wKTogdm9pZCB7XG4gIGxldCBhc3NvY2lhdGVkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmICghYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQgPSBuZXcgU2V0KCk7XG4gICAgTElOS0VELnNldChwYXJlbnQsIGFzc29jaWF0ZWQpO1xuICB9XG5cbiAgYXNzb2NpYXRlZC5hZGQoY2hpbGQpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGVla0Fzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpOiBPcHRpb248U2V0PERyb3A+PiB7XG4gIHJldHVybiBMSU5LRUQuZ2V0KHBhcmVudCkgfHwgbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRha2VBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KTogT3B0aW9uPFNldDxEcm9wPj4ge1xuICBsZXQgbGlua2VkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmIChsaW5rZWQgJiYgbGlua2VkLnNpemUgPiAwKSB7XG4gICAgTElOS0VELmRlbGV0ZShwYXJlbnQpO1xuICAgIHJldHVybiBsaW5rZWQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdpbGxEZXN0cm95QXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCkge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGl0ZW1bV0lMTF9EUk9QXSgpO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkaWREZXN0cm95QXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCkge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGl0ZW1bRElEX0RST1BdKCk7XG4gICAgICBhc3NvY2lhdGVkIS5kZWxldGUoaXRlbSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc3RydWN0b3IodmFsdWU6IG9iamVjdCk6IERyb3Age1xuICBsZXQgZCA9IERFU1RSVUNUT1JTLmdldCh2YWx1ZSk7XG5cbiAgaWYgKCFkKSB7XG4gICAgaWYgKGlzRGVzdHJveWFibGUodmFsdWUpKSB7XG4gICAgICBkID0gbmV3IERlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChpc1N0cmluZ0Rlc3Ryb3lhYmxlKHZhbHVlKSkge1xuICAgICAgZCA9IG5ldyBTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3IodmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkID0gbmV3IFNpbXBsZURlc3RydWN0b3IodmFsdWUpO1xuICAgIH1cblxuICAgIERFU1RSVUNUT1JTLnNldCh2YWx1ZSwgZCk7XG4gIH1cblxuICByZXR1cm4gZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNuYXBzaG90KHZhbHVlczogU2V0PERyb3A+KTogRHJvcCB7XG4gIHJldHVybiBuZXcgU25hcHNob3REZXN0cnVjdG9yKHZhbHVlcyk7XG59XG5cbmNsYXNzIFNuYXBzaG90RGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRlc3RydWN0b3JzOiBTZXQ8RHJvcD4pIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5mb3JFYWNoKGl0ZW0gPT4gaXRlbVtXSUxMX0RST1BdKCkpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmRlc3RydWN0b3JzLmZvckVhY2goaXRlbSA9PiBpdGVtW0RJRF9EUk9QXSgpKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gdGhpcy5kZXN0cnVjdG9ycztcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU25hcHNob3REZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBEZXN0cm95YWJsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogU3ltYm9sRGVzdHJveWFibGUpIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyW0RFU1RST1ldKCk7XG4gICAgZGlkRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIExJTktFRC5nZXQodGhpcy5pbm5lcikgfHwgW107XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuY2xhc3MgU3RyaW5nRGVzdHJveWFibGVEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IERlc3Ryb3lhYmxlKSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5pbm5lci53aWxsRGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5pbm5lci53aWxsRGVzdHJveSgpO1xuICAgIH1cbiAgICB3aWxsRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZGVzdHJveSgpO1xuICAgIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIFNpbXBsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogb2JqZWN0KSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHdpbGxEZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgZGlkRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIExJTktFRC5nZXQodGhpcy5pbm5lcikgfHwgW107XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ1NpbXBsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBMaXN0Q29udGVudHNEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IExpbmtlZExpc3Q8TGlua2VkTGlzdE5vZGU+KSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBkZXN0cnVjdG9yKGQpW1dJTExfRFJPUF0oKSk7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBkZXN0cnVjdG9yKGQpW0RJRF9EUk9QXSgpKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICBsZXQgb3V0OiBEcm9wW10gPSBbXTtcbiAgICB0aGlzLmlubmVyLmZvckVhY2hOb2RlKGQgPT4gb3V0LnB1c2goLi4uZGVzdHJ1Y3RvcihkKVtDSElMRFJFTl0pKTtcbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdMaXN0Q29udGVudHNEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIERlYnVnTm9kZSB7XG4gIGlubmVyOiBvYmplY3Q7XG4gIGNoaWxkcmVuOiBEZWJ1Z05vZGVbXSB8IG51bGw7XG4gIGhhc0Ryb3A6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWJ1Z0Ryb3BUcmVlKGlubmVyOiBvYmplY3QpOiBEZWJ1Z05vZGUge1xuICBsZXQgaGFzRHJvcCA9IGlzRHJvcChpbm5lcik7XG4gIGxldCByYXdDaGlsZHJlbiA9IExJTktFRC5nZXQoaW5uZXIpIHx8IG51bGw7XG4gIGxldCBjaGlsZHJlbjogRGVidWdOb2RlW10gfCBudWxsID0gbnVsbDtcblxuICBpZiAocmF3Q2hpbGRyZW4pIHtcbiAgICBjaGlsZHJlbiA9IFtdO1xuICAgIGZvciAobGV0IGNoaWxkIG9mIHJhd0NoaWxkcmVuKSB7XG4gICAgICBjaGlsZHJlbi5wdXNoKGRlYnVnRHJvcFRyZWUoY2hpbGQpKTtcbiAgICB9XG4gIH1cblxuICBsZXQgb2JqID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgb2JqLmlubmVyID0gaW5uZXI7XG4gIGlmIChjaGlsZHJlbikge1xuICAgIG9iai5jaGlsZHJlbiA9IGNoaWxkcmVuO1xuICB9XG4gIG9iai5oYXNEcm9wID0gaGFzRHJvcDtcbiAgcmV0dXJuIG9iajtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByaW50RHJvcFRyZWUoaW5uZXI6IG9iamVjdCkge1xuICBwcmludERyb3AoZGVzdHJ1Y3Rvcihpbm5lcikpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnREcm9wKGlubmVyOiBEcm9wKSB7XG4gIGNvbnNvbGUuZ3JvdXAoU3RyaW5nKGlubmVyKSk7XG5cbiAgY29uc29sZS5sb2coaW5uZXIpO1xuXG4gIGxldCBjaGlsZHJlbiA9IGlubmVyW0NISUxEUkVOXSB8fCBudWxsO1xuICBpZiAoY2hpbGRyZW4pIHtcbiAgICBmb3IgKGxldCBjaGlsZCBvZiBjaGlsZHJlbikge1xuICAgICAgcHJpbnREcm9wKGNoaWxkKTtcbiAgICB9XG4gIH1cblxuICBjb25zb2xlLmdyb3VwRW5kKCk7XG59XG5cbmlmIChMT0NBTF9ERUJVRyAmJiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykge1xuICAod2luZG93IGFzIGFueSkuUFJJTlRfRFJPUCA9IHByaW50RHJvcFRyZWU7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9