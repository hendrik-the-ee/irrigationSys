"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.isDrop = isDrop;
exports.associate = associate;
exports.associateDestructor = associateDestructor;
exports.peekAssociated = peekAssociated;
exports.takeAssociated = takeAssociated;
exports.willDestroyAssociated = willDestroyAssociated;
exports.didDestroyAssociated = didDestroyAssociated;
exports.destructor = destructor;
exports.snapshot = snapshot;
exports.debugDropTree = debugDropTree;
exports.printDropTree = printDropTree;
exports.printDrop = printDrop;
exports.ListContentsDestructor = exports.DESTRUCTORS = exports.CHILDREN = exports.DID_DROP = exports.WILL_DROP = exports.LINKED = void 0;

var _destroy = require("./destroy");

var _platformUtils = require("./platform-utils");

const LINKED = new WeakMap();
exports.LINKED = LINKED;
const WILL_DROP = (0, _platformUtils.symbol)('WILL_DROP');
exports.WILL_DROP = WILL_DROP;
const DID_DROP = (0, _platformUtils.symbol)('DID_DROP');
exports.DID_DROP = DID_DROP;
const CHILDREN = (0, _platformUtils.symbol)('CHILDREN');
exports.CHILDREN = CHILDREN;
const DESTRUCTORS = new WeakMap();
exports.DESTRUCTORS = DESTRUCTORS;

function isDrop(value) {
  if (value === null || typeof value !== 'object') return false;
  return value[DID_DROP] !== undefined;
}

function associate(parent, child) {
  associateDestructor(parent, destructor(child));
}

function associateDestructor(parent, child) {
  let associated = LINKED.get(parent);

  if (!associated) {
    associated = new Set();
    LINKED.set(parent, associated);
  }

  associated.add(child);
}

function peekAssociated(parent) {
  return LINKED.get(parent) || null;
}

function takeAssociated(parent) {
  let linked = LINKED.get(parent);

  if (linked && linked.size > 0) {
    LINKED.delete(parent);
    return linked;
  } else {
    return null;
  }
}

function willDestroyAssociated(parent) {
  let associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(item => {
      item[WILL_DROP]();
    });
  }
}

function didDestroyAssociated(parent) {
  let associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(item => {
      item[DID_DROP]();
      associated.delete(item);
    });
  }
}

function destructor(value) {
  let d = DESTRUCTORS.get(value);

  if (!d) {
    if ((0, _destroy.isDestroyable)(value)) {
      d = new DestroyableDestructor(value);
    } else if ((0, _destroy.isStringDestroyable)(value)) {
      d = new StringDestroyableDestructor(value);
    } else {
      d = new SimpleDestructor(value);
    }

    DESTRUCTORS.set(value, d);
  }

  return d;
}

function snapshot(values) {
  return new SnapshotDestructor(values);
}

class SnapshotDestructor {
  constructor(destructors) {
    this.destructors = destructors;
  }

  [WILL_DROP]() {
    this.destructors.forEach(item => item[WILL_DROP]());
  }

  [DID_DROP]() {
    this.destructors.forEach(item => item[DID_DROP]());
  }

  get [CHILDREN]() {
    return this.destructors;
  }

  toString() {
    return 'SnapshotDestructor';
  }

}

class DestroyableDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    willDestroyAssociated(this.inner);
  }

  [DID_DROP]() {
    this.inner[_destroy.DESTROY]();

    didDestroyAssociated(this.inner);
  }

  get [CHILDREN]() {
    return LINKED.get(this.inner) || [];
  }

  toString() {
    return 'DestroyableDestructor';
  }

}

class StringDestroyableDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    if (typeof this.inner.willDestroy === 'function') {
      this.inner.willDestroy();
    }

    willDestroyAssociated(this.inner);
  }

  [DID_DROP]() {
    this.inner.destroy();
    didDestroyAssociated(this.inner);
  }

  get [CHILDREN]() {
    return LINKED.get(this.inner) || [];
  }

  toString() {
    return 'StringDestroyableDestructor';
  }

}

class SimpleDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    willDestroyAssociated(this.inner);
  }

  [DID_DROP]() {
    didDestroyAssociated(this.inner);
  }

  get [CHILDREN]() {
    return LINKED.get(this.inner) || [];
  }

  toString() {
    return 'SimpleDestructor';
  }

}

class ListContentsDestructor {
  constructor(inner) {
    this.inner = inner;
  }

  [WILL_DROP]() {
    this.inner.forEachNode(d => destructor(d)[WILL_DROP]());
  }

  [DID_DROP]() {
    this.inner.forEachNode(d => destructor(d)[DID_DROP]());
  }

  get [CHILDREN]() {
    let out = [];
    this.inner.forEachNode(d => out.push(...destructor(d)[CHILDREN]));
    return out;
  }

  toString() {
    return 'ListContentsDestructor';
  }

}

exports.ListContentsDestructor = ListContentsDestructor;

function debugDropTree(inner) {
  let hasDrop = isDrop(inner);
  let rawChildren = LINKED.get(inner) || null;
  let children = null;

  if (rawChildren) {
    children = [];

    for (let child of rawChildren) {
      children.push(debugDropTree(child));
    }
  }

  let obj = Object.create(null);
  obj.inner = inner;

  if (children) {
    obj.children = children;
  }

  obj.hasDrop = hasDrop;
  return obj;
}

function printDropTree(inner) {
  printDrop(destructor(inner));
}

function printDrop(inner) {
  console.group(String(inner));
  console.log(inner);
  let children = inner[CHILDREN] || null;

  if (children) {
    for (let child of children) {
      printDrop(child);
    }
  }

  console.groupEnd();
}

if (false
/* LOCAL_DEBUG */
&& typeof window !== 'undefined') {
  window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBWUE7O0FBRU8sTUFBTSxNQUFNLEdBQStCLElBQTNDLE9BQTJDLEVBQTNDOztBQUNBLE1BQU0sU0FBUyxHQUFtQiwyQkFBbEMsV0FBa0MsQ0FBbEM7O0FBQ0EsTUFBTSxRQUFRLEdBQWtCLDJCQUFoQyxVQUFnQyxDQUFoQzs7QUFDQSxNQUFNLFFBQVEsR0FBbUIsMkJBQWpDLFVBQWlDLENBQWpDOztBQUNBLE1BQU0sV0FBVyxHQUFHLElBQXBCLE9BQW9CLEVBQXBCOzs7QUFFRCxTQUFBLE1BQUEsQ0FBQSxLQUFBLEVBQStCO0FBQ25DLE1BQUksS0FBSyxLQUFMLElBQUEsSUFBa0IsT0FBQSxLQUFBLEtBQXRCLFFBQUEsRUFBaUQsT0FBQSxLQUFBO0FBQ2pELFNBQVEsS0FBYyxDQUFkLFFBQWMsQ0FBZCxLQUFSLFNBQUE7QUFDRDs7QUFFSyxTQUFBLFNBQUEsQ0FBQSxNQUFBLEVBQUEsS0FBQSxFQUFpRDtBQUNyRCxFQUFBLG1CQUFtQixDQUFBLE1BQUEsRUFBUyxVQUFVLENBQXRDLEtBQXNDLENBQW5CLENBQW5CO0FBQ0Q7O0FBRUssU0FBQSxtQkFBQSxDQUFBLE1BQUEsRUFBQSxLQUFBLEVBQXlEO0FBQzdELE1BQUksVUFBVSxHQUFHLE1BQU0sQ0FBTixHQUFBLENBQWpCLE1BQWlCLENBQWpCOztBQUVBLE1BQUksQ0FBSixVQUFBLEVBQWlCO0FBQ2YsSUFBQSxVQUFVLEdBQUcsSUFBYixHQUFhLEVBQWI7QUFDQSxJQUFBLE1BQU0sQ0FBTixHQUFBLENBQUEsTUFBQSxFQUFBLFVBQUE7QUFDRDs7QUFFRCxFQUFBLFVBQVUsQ0FBVixHQUFBLENBQUEsS0FBQTtBQUNEOztBQUVLLFNBQUEsY0FBQSxDQUFBLE1BQUEsRUFBdUM7QUFDM0MsU0FBTyxNQUFNLENBQU4sR0FBQSxD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QVYsSUFBVSxDQUFWO0FBQ0EsRUFBQSxHQUFHLENBQUgsS0FBQSxHQUFBLEtBQUE7O0FBQ0EsTUFBQSxRQUFBLEVBQWM7QUFDWixJQUFBLEdBQUcsQ0FBSCxRQUFBLEdBQUEsUUFBQTtBQUNEOztBQUNELEVBQUEsR0FBRyxDQUFILE9BQUEsR0FBQSxPQUFBO0FBQ0EsU0FBQSxHQUFBO0FBQ0Q7O0FBRUssU0FBQSxhQUFBLENBQUEsS0FBQSxFQUFxQztBQUN6QyxFQUFBLFNBQVMsQ0FBQyxVQUFVLENBQXBCLEtBQW9CLENBQVgsQ0FBVDtBQUNEOztBQUVLLFNBQUEsU0FBQSxDQUFBLEtBQUEsRUFBK0I7QUFDbkMsRUFBQSxPQUFPLENBQVAsS0FBQSxDQUFjLE1BQU0sQ0FBcEIsS0FBb0IsQ0FBcEI7QUFFQSxFQUFBLE9BQU8sQ0FBUCxHQUFBLENBQUEsS0FBQTtBQUVBLE1BQUksUUFBUSxHQUFHLEtBQUssQ0FBTCxRQUFLLENBQUwsSUFBZixJQUFBOztBQUNBLE1BQUEsUUFBQSxFQUFjO0FBQ1osU0FBSyxJQUFMLEtBQUEsSUFBQSxRQUFBLEVBQTRCO0FBQzFCLE1BQUEsU0FBUyxDQUFULEtBQVMsQ0FBVDtBQUNEO0FBQ0Y7O0FBRUQsRUFBQSxPQUFPLENBQVAsUUFBQTtBQUNEOztBQUVELElBQUk7QUFBQTtBQUFBLEdBQWUsT0FBQSxNQUFBLEtBQW5CLFdBQUEsRUFBa0Q7QUFDL0MsRUFBQSxNQUFjLENBQWQsVUFBQSxHQUFBLGFBQUE7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzRGVzdHJveWFibGUsIGlzU3RyaW5nRGVzdHJveWFibGUsIERFU1RST1kgfSBmcm9tICcuL2Rlc3Ryb3knO1xuaW1wb3J0IHtcbiAgT3B0aW9uLFxuICBTeW1ib2xEZXN0cm95YWJsZSxcbiAgRGVzdHJveWFibGUsXG4gIERyb3AsXG4gIFdpbGxEcm9wU3ltYm9sLFxuICBEaWREcm9wU3ltYm9sLFxuICBDaGlsZHJlblN5bWJvbCxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBMaW5rZWRMaXN0LCBMaW5rZWRMaXN0Tm9kZSB9IGZyb20gJy4vbGlzdC11dGlscyc7XG5pbXBvcnQgeyBMT0NBTF9ERUJVRyB9IGZyb20gJ0BnbGltbWVyL2xvY2FsLWRlYnVnLWZsYWdzJztcbmltcG9ydCB7IHN5bWJvbCB9IGZyb20gJy4vcGxhdGZvcm0tdXRpbHMnO1xuXG5leHBvcnQgY29uc3QgTElOS0VEOiBXZWFrTWFwPG9iamVjdCwgU2V0PERyb3A+PiA9IG5ldyBXZWFrTWFwKCk7XG5leHBvcnQgY29uc3QgV0lMTF9EUk9QOiBXaWxsRHJvcFN5bWJvbCA9IHN5bWJvbCgnV0lMTF9EUk9QJyk7XG5leHBvcnQgY29uc3QgRElEX0RST1A6IERpZERyb3BTeW1ib2wgPSBzeW1ib2woJ0RJRF9EUk9QJyk7XG5leHBvcnQgY29uc3QgQ0hJTERSRU46IENoaWxkcmVuU3ltYm9sID0gc3ltYm9sKCdDSElMRFJFTicpO1xuZXhwb3J0IGNvbnN0IERFU1RSVUNUT1JTID0gbmV3IFdlYWtNYXAoKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzRHJvcCh2YWx1ZTogdW5rbm93bik6IHZhbHVlIGlzIERyb3Age1xuICBpZiAodmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlO1xuICByZXR1cm4gKHZhbHVlIGFzIERyb3ApW0RJRF9EUk9QXSAhPT0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXNzb2NpYXRlKHBhcmVudDogb2JqZWN0LCBjaGlsZDogb2JqZWN0KSB7XG4gIGFzc29jaWF0ZURlc3RydWN0b3IocGFyZW50LCBkZXN0cnVjdG9yKGNoaWxkKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhc3NvY2lhdGVEZXN0cnVjdG9yKHBhcmVudDogb2JqZWN0LCBjaGlsZDogRHJvcCk6IHZvaWQge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoIWFzc29jaWF0ZWQpIHtcbiAgICBhc3NvY2lhdGVkID0gbmV3IFNldCgpO1xuICAgIExJTktFRC5zZXQocGFyZW50LCBhc3NvY2lhdGVkKTtcbiAgfVxuXG4gIGFzc29jaWF0ZWQuYWRkKGNoaWxkKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlZWtBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KTogT3B0aW9uPFNldDxEcm9wPj4ge1xuICByZXR1cm4gTElOS0VELmdldChwYXJlbnQpIHx8IG51bGw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0YWtlQXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCk6IE9wdGlvbjxTZXQ8RHJvcD4+IHtcbiAgbGV0IGxpbmtlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAobGlua2VkICYmIGxpbmtlZC5zaXplID4gMCkge1xuICAgIExJTktFRC5kZWxldGUocGFyZW50KTtcbiAgICByZXR1cm4gbGlua2VkO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3aWxsRGVzdHJveUFzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKGFzc29jaWF0ZWQpIHtcbiAgICBhc3NvY2lhdGVkLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtW1dJTExfRFJPUF0oKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlkRGVzdHJveUFzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKGFzc29jaWF0ZWQpIHtcbiAgICBhc3NvY2lhdGVkLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpdGVtW0RJRF9EUk9QXSgpO1xuICAgICAgYXNzb2NpYXRlZCEuZGVsZXRlKGl0ZW0pO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cnVjdG9yKHZhbHVlOiBvYmplY3QpOiBEcm9wIHtcbiAgbGV0IGQgPSBERVNUUlVDVE9SUy5nZXQodmFsdWUpO1xuXG4gIGlmICghZCkge1xuICAgIGlmIChpc0Rlc3Ryb3lhYmxlKHZhbHVlKSkge1xuICAgICAgZCA9IG5ldyBEZXN0cm95YWJsZURlc3RydWN0b3IodmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoaXNTdHJpbmdEZXN0cm95YWJsZSh2YWx1ZSkpIHtcbiAgICAgIGQgPSBuZXcgU3RyaW5nRGVzdHJveWFibGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZCA9IG5ldyBTaW1wbGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9XG5cbiAgICBERVNUUlVDVE9SUy5zZXQodmFsdWUsIGQpO1xuICB9XG5cbiAgcmV0dXJuIGQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzbmFwc2hvdCh2YWx1ZXM6IFNldDxEcm9wPik6IERyb3Age1xuICByZXR1cm4gbmV3IFNuYXBzaG90RGVzdHJ1Y3Rvcih2YWx1ZXMpO1xufVxuXG5jbGFzcyBTbmFwc2hvdERlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkZXN0cnVjdG9yczogU2V0PERyb3A+KSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHRoaXMuZGVzdHJ1Y3RvcnMuZm9yRWFjaChpdGVtID0+IGl0ZW1bV0lMTF9EUk9QXSgpKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5mb3JFYWNoKGl0ZW0gPT4gaXRlbVtESURfRFJPUF0oKSk7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIHRoaXMuZGVzdHJ1Y3RvcnM7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ1NuYXBzaG90RGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuY2xhc3MgRGVzdHJveWFibGVEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IFN5bWJvbERlc3Ryb3lhYmxlKSB7fVxuXG4gIFtXSUxMX0RST1BdKCkge1xuICAgIHdpbGxEZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lcltERVNUUk9ZXSgpO1xuICAgIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdEZXN0cm95YWJsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIFN0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBEZXN0cm95YWJsZSkge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMuaW5uZXIud2lsbERlc3Ryb3kgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuaW5uZXIud2lsbERlc3Ryb3koKTtcbiAgICB9XG4gICAgd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyLmRlc3Ryb3koKTtcbiAgICBkaWREZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU3RyaW5nRGVzdHJveWFibGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBTaW1wbGVEZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5uZXI6IG9iamVjdCkge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB3aWxsRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTaW1wbGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTGlzdENvbnRlbnRzRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBMaW5rZWRMaXN0PExpbmtlZExpc3ROb2RlPikge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyLmZvckVhY2hOb2RlKGQgPT4gZGVzdHJ1Y3RvcihkKVtXSUxMX0RST1BdKCkpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICB0aGlzLmlubmVyLmZvckVhY2hOb2RlKGQgPT4gZGVzdHJ1Y3RvcihkKVtESURfRFJPUF0oKSk7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgbGV0IG91dDogRHJvcFtdID0gW107XG4gICAgdGhpcy5pbm5lci5mb3JFYWNoTm9kZShkID0+IG91dC5wdXNoKC4uLmRlc3RydWN0b3IoZClbQ0hJTERSRU5dKSk7XG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnTGlzdENvbnRlbnRzRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZWJ1Z05vZGUge1xuICBpbm5lcjogb2JqZWN0O1xuICBjaGlsZHJlbjogRGVidWdOb2RlW10gfCBudWxsO1xuICBoYXNEcm9wOiBib29sZWFuO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVidWdEcm9wVHJlZShpbm5lcjogb2JqZWN0KTogRGVidWdOb2RlIHtcbiAgbGV0IGhhc0Ryb3AgPSBpc0Ryb3AoaW5uZXIpO1xuICBsZXQgcmF3Q2hpbGRyZW4gPSBMSU5LRUQuZ2V0KGlubmVyKSB8fCBudWxsO1xuICBsZXQgY2hpbGRyZW46IERlYnVnTm9kZVtdIHwgbnVsbCA9IG51bGw7XG5cbiAgaWYgKHJhd0NoaWxkcmVuKSB7XG4gICAgY2hpbGRyZW4gPSBbXTtcbiAgICBmb3IgKGxldCBjaGlsZCBvZiByYXdDaGlsZHJlbikge1xuICAgICAgY2hpbGRyZW4ucHVzaChkZWJ1Z0Ryb3BUcmVlKGNoaWxkKSk7XG4gICAgfVxuICB9XG5cbiAgbGV0IG9iaiA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gIG9iai5pbm5lciA9IGlubmVyO1xuICBpZiAoY2hpbGRyZW4pIHtcbiAgICBvYmouY2hpbGRyZW4gPSBjaGlsZHJlbjtcbiAgfVxuICBvYmouaGFzRHJvcCA9IGhhc0Ryb3A7XG4gIHJldHVybiBvYmo7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludERyb3BUcmVlKGlubmVyOiBvYmplY3QpIHtcbiAgcHJpbnREcm9wKGRlc3RydWN0b3IoaW5uZXIpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByaW50RHJvcChpbm5lcjogRHJvcCkge1xuICBjb25zb2xlLmdyb3VwKFN0cmluZyhpbm5lcikpO1xuXG4gIGNvbnNvbGUubG9nKGlubmVyKTtcblxuICBsZXQgY2hpbGRyZW4gPSBpbm5lcltDSElMRFJFTl0gfHwgbnVsbDtcbiAgaWYgKGNoaWxkcmVuKSB7XG4gICAgZm9yIChsZXQgY2hpbGQgb2YgY2hpbGRyZW4pIHtcbiAgICAgIHByaW50RHJvcChjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgY29uc29sZS5ncm91cEVuZCgpO1xufVxuXG5pZiAoTE9DQUxfREVCVUcgJiYgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgKHdpbmRvdyBhcyBhbnkpLlBSSU5UX0RST1AgPSBwcmludERyb3BUcmVlO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==