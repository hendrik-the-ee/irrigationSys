function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

import { isDestroyable, isStringDestroyable, DESTROY } from './destroy';
import { symbol } from './platform-utils';
export var LINKED = new WeakMap();
export var WILL_DROP = symbol('WILL_DROP');
export var DID_DROP = symbol('DID_DROP');
export var CHILDREN = symbol('CHILDREN');
export var DESTRUCTORS = new WeakMap();
export function isDrop(value) {
  if (value === null || typeof value !== 'object') return false;
  return value[DID_DROP] !== undefined;
}
export function associate(parent, child) {
  associateDestructor(parent, destructor(child));
}
export function associateDestructor(parent, child) {
  var associated = LINKED.get(parent);

  if (!associated) {
    associated = new Set();
    LINKED.set(parent, associated);
  }

  associated.add(child);
}
export function peekAssociated(parent) {
  return LINKED.get(parent) || null;
}
export function takeAssociated(parent) {
  var linked = LINKED.get(parent);

  if (linked && linked.size > 0) {
    LINKED["delete"](parent);
    return linked;
  } else {
    return null;
  }
}
export function willDestroyAssociated(parent) {
  var associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(function (item) {
      item[WILL_DROP]();
    });
  }
}
export function didDestroyAssociated(parent) {
  var associated = LINKED.get(parent);

  if (associated) {
    associated.forEach(function (item) {
      item[DID_DROP]();
      associated["delete"](item);
    });
  }
}
export function destructor(value) {
  var d = DESTRUCTORS.get(value);

  if (!d) {
    if (isDestroyable(value)) {
      d = new DestroyableDestructor(value);
    } else if (isStringDestroyable(value)) {
      d = new StringDestroyableDestructor(value);
    } else {
      d = new SimpleDestructor(value);
    }

    DESTRUCTORS.set(value, d);
  }

  return d;
}
export function snapshot(values) {
  return new SnapshotDestructor(values);
}

var SnapshotDestructor =
/*#__PURE__*/
function () {
  function SnapshotDestructor(destructors) {
    this.destructors = destructors;
  }

  var _proto = SnapshotDestructor.prototype;

  _proto[WILL_DROP] = function () {
    this.destructors.forEach(function (item) {
      return item[WILL_DROP]();
    });
  };

  _proto[DID_DROP] = function () {
    this.destructors.forEach(function (item) {
      return item[DID_DROP]();
    });
  };

  _proto.toString = function toString() {
    return 'SnapshotDestructor';
  };

  _createClass(SnapshotDestructor, [{
    key: CHILDREN,
    get: function get() {
      return this.destructors;
    }
  }]);

  return SnapshotDestructor;
}();

var DestroyableDestructor =
/*#__PURE__*/
function () {
  function DestroyableDestructor(inner) {
    this.inner = inner;
  }

  var _proto2 = DestroyableDestructor.prototype;

  _proto2[WILL_DROP] = function () {
    willDestroyAssociated(this.inner);
  };

  _proto2[DID_DROP] = function () {
    this.inner[DESTROY]();
    didDestroyAssociated(this.inner);
  };

  _proto2.toString = function toString() {
    return 'DestroyableDestructor';
  };

  _createClass(DestroyableDestructor, [{
    key: CHILDREN,
    get: function get() {
      return LINKED.get(this.inner) || [];
    }
  }]);

  return DestroyableDestructor;
}();

var StringDestroyableDestructor =
/*#__PURE__*/
function () {
  function StringDestroyableDestructor(inner) {
    this.inner = inner;
  }

  var _proto3 = StringDestroyableDestructor.prototype;

  _proto3[WILL_DROP] = function () {
    if (typeof this.inner.willDestroy === 'function') {
      this.inner.willDestroy();
    }

    willDestroyAssociated(this.inner);
  };

  _proto3[DID_DROP] = function () {
    this.inner.destroy();
    didDestroyAssociated(this.inner);
  };

  _proto3.toString = function toString() {
    return 'StringDestroyableDestructor';
  };

  _createClass(StringDestroyableDestructor, [{
    key: CHILDREN,
    get: function get() {
      return LINKED.get(this.inner) || [];
    }
  }]);

  return StringDestroyableDestructor;
}();

var SimpleDestructor =
/*#__PURE__*/
function () {
  function SimpleDestructor(inner) {
    this.inner = inner;
  }

  var _proto4 = SimpleDestructor.prototype;

  _proto4[WILL_DROP] = function () {
    willDestroyAssociated(this.inner);
  };

  _proto4[DID_DROP] = function () {
    didDestroyAssociated(this.inner);
  };

  _proto4.toString = function toString() {
    return 'SimpleDestructor';
  };

  _createClass(SimpleDestructor, [{
    key: CHILDREN,
    get: function get() {
      return LINKED.get(this.inner) || [];
    }
  }]);

  return SimpleDestructor;
}();

export var ListContentsDestructor =
/*#__PURE__*/
function () {
  function ListContentsDestructor(inner) {
    this.inner = inner;
  }

  var _proto5 = ListContentsDestructor.prototype;

  _proto5[WILL_DROP] = function () {
    this.inner.forEachNode(function (d) {
      return destructor(d)[WILL_DROP]();
    });
  };

  _proto5[DID_DROP] = function () {
    this.inner.forEachNode(function (d) {
      return destructor(d)[DID_DROP]();
    });
  };

  _proto5.toString = function toString() {
    return 'ListContentsDestructor';
  };

  _createClass(ListContentsDestructor, [{
    key: CHILDREN,
    get: function get() {
      var out = [];
      this.inner.forEachNode(function (d) {
        return out.push.apply(out, destructor(d)[CHILDREN]);
      });
      return out;
    }
  }]);

  return ListContentsDestructor;
}();
export function debugDropTree(inner) {
  var hasDrop = isDrop(inner);
  var rawChildren = LINKED.get(inner) || null;
  var children = null;

  if (rawChildren) {
    children = [];

    for (var _iterator = rawChildren, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
      var _ref;

      if (_isArray) {
        if (_i >= _iterator.length) break;
        _ref = _iterator[_i++];
      } else {
        _i = _iterator.next();
        if (_i.done) break;
        _ref = _i.value;
      }

      var child = _ref;
      children.push(debugDropTree(child));
    }
  }

  var obj = Object.create(null);
  obj.inner = inner;

  if (children) {
    obj.children = children;
  }

  obj.hasDrop = hasDrop;
  return obj;
}
export function printDropTree(inner) {
  printDrop(destructor(inner));
}
export function printDrop(inner) {
  console.group(String(inner));
  console.log(inner);
  var children = inner[CHILDREN] || null;

  if (children) {
    for (var _iterator2 = children, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
      var _ref2;

      if (_isArray2) {
        if (_i2 >= _iterator2.length) break;
        _ref2 = _iterator2[_i2++];
      } else {
        _i2 = _iterator2.next();
        if (_i2.done) break;
        _ref2 = _i2.value;
      }

      var child = _ref2;
      printDrop(child);
    }
  }

  console.groupEnd();
}

if (false
/* LOCAL_DEBUG */
&& typeof window !== 'undefined') {
  window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsU0FBQSxhQUFBLEVBQUEsbUJBQUEsRUFBQSxPQUFBLFFBQUEsV0FBQTtBQVlBLFNBQUEsTUFBQSxRQUFBLGtCQUFBO0FBRUEsT0FBTyxJQUFNLE1BQU0sR0FBK0IsSUFBM0MsT0FBMkMsRUFBM0M7QUFDUCxPQUFPLElBQU0sU0FBUyxHQUFtQixNQUFNLENBQXhDLFdBQXdDLENBQXhDO0FBQ1AsT0FBTyxJQUFNLFFBQVEsR0FBa0IsTUFBTSxDQUF0QyxVQUFzQyxDQUF0QztBQUNQLE9BQU8sSUFBTSxRQUFRLEdBQW1CLE1BQU0sQ0FBdkMsVUFBdUMsQ0FBdkM7QUFDUCxPQUFPLElBQU0sV0FBVyxHQUFHLElBQXBCLE9BQW9CLEVBQXBCO0FBRVAsT0FBTSxTQUFBLE1BQUEsQ0FBQSxLQUFBLEVBQStCO0FBQ25DLE1BQUksS0FBSyxLQUFMLElBQUEsSUFBa0IsT0FBQSxLQUFBLEtBQXRCLFFBQUEsRUFBaUQsT0FBQSxLQUFBO0FBQ2pELFNBQVEsS0FBYyxDQUFkLFFBQWMsQ0FBZCxLQUFSLFNBQUE7QUFDRDtBQUVELE9BQU0sU0FBQSxTQUFBLENBQUEsTUFBQSxFQUFBLEtBQUEsRUFBaUQ7QUFDckQsRUFBQSxtQkFBbUIsQ0FBQSxNQUFBLEVBQVMsVUFBVSxDQUF0QyxLQUFzQyxDQUFuQixDQUFuQjtBQUNEO0FBRUQsT0FBTSxTQUFBLG1CQUFBLENBQUEsTUFBQSxFQUFBLEtBQUEsRUFBeUQ7QUFDN0QsTUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFOLEdBQUEsQ0FBakIsTUFBaUIsQ0FBakI7O0FBRUEsTUFBSSxDQUFKLFVBQUEsRUFBaUI7QUFDZixJQUFBLFVBQVUsR0FBRyxJQUFiLEdBQWEsRUFBYjtBQUNBLElBQUEsTUFBTSxDQUFOLEdBQUEsQ0FBQSxNQUFBLEVBQUEsVUFBQTtBQUNEOztBQUVELEVBQUEs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O0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0Rlc3Ryb3lhYmxlLCBpc1N0cmluZ0Rlc3Ryb3lhYmxlLCBERVNUUk9ZIH0gZnJvbSAnLi9kZXN0cm95JztcbmltcG9ydCB7XG4gIE9wdGlvbixcbiAgU3ltYm9sRGVzdHJveWFibGUsXG4gIERlc3Ryb3lhYmxlLFxuICBEcm9wLFxuICBXaWxsRHJvcFN5bWJvbCxcbiAgRGlkRHJvcFN5bWJvbCxcbiAgQ2hpbGRyZW5TeW1ib2wsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgTGlua2VkTGlzdCwgTGlua2VkTGlzdE5vZGUgfSBmcm9tICcuL2xpc3QtdXRpbHMnO1xuaW1wb3J0IHsgTE9DQUxfREVCVUcgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5pbXBvcnQgeyBzeW1ib2wgfSBmcm9tICcuL3BsYXRmb3JtLXV0aWxzJztcblxuZXhwb3J0IGNvbnN0IExJTktFRDogV2Vha01hcDxvYmplY3QsIFNldDxEcm9wPj4gPSBuZXcgV2Vha01hcCgpO1xuZXhwb3J0IGNvbnN0IFdJTExfRFJPUDogV2lsbERyb3BTeW1ib2wgPSBzeW1ib2woJ1dJTExfRFJPUCcpO1xuZXhwb3J0IGNvbnN0IERJRF9EUk9QOiBEaWREcm9wU3ltYm9sID0gc3ltYm9sKCdESURfRFJPUCcpO1xuZXhwb3J0IGNvbnN0IENISUxEUkVOOiBDaGlsZHJlblN5bWJvbCA9IHN5bWJvbCgnQ0hJTERSRU4nKTtcbmV4cG9ydCBjb25zdCBERVNUUlVDVE9SUyA9IG5ldyBXZWFrTWFwKCk7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0Ryb3AodmFsdWU6IHVua25vd24pOiB2YWx1ZSBpcyBEcm9wIHtcbiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSAhPT0gJ29iamVjdCcpIHJldHVybiBmYWxzZTtcbiAgcmV0dXJuICh2YWx1ZSBhcyBEcm9wKVtESURfRFJPUF0gIT09IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc29jaWF0ZShwYXJlbnQ6IG9iamVjdCwgY2hpbGQ6IG9iamVjdCkge1xuICBhc3NvY2lhdGVEZXN0cnVjdG9yKHBhcmVudCwgZGVzdHJ1Y3RvcihjaGlsZCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXNzb2NpYXRlRGVzdHJ1Y3RvcihwYXJlbnQ6IG9iamVjdCwgY2hpbGQ6IERyb3ApOiB2b2lkIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKCFhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZCA9IG5ldyBTZXQoKTtcbiAgICBMSU5LRUQuc2V0KHBhcmVudCwgYXNzb2NpYXRlZCk7XG4gIH1cblxuICBhc3NvY2lhdGVkLmFkZChjaGlsZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZWVrQXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCk6IE9wdGlvbjxTZXQ8RHJvcD4+IHtcbiAgcmV0dXJuIExJTktFRC5nZXQocGFyZW50KSB8fCBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdGFrZUFzc29jaWF0ZWQocGFyZW50OiBvYmplY3QpOiBPcHRpb248U2V0PERyb3A+PiB7XG4gIGxldCBsaW5rZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKGxpbmtlZCAmJiBsaW5rZWQuc2l6ZSA+IDApIHtcbiAgICBMSU5LRUQuZGVsZXRlKHBhcmVudCk7XG4gICAgcmV0dXJuIGxpbmtlZDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KSB7XG4gIGxldCBhc3NvY2lhdGVkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmIChhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZC5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbVtXSUxMX0RST1BdKCk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpZERlc3Ryb3lBc3NvY2lhdGVkKHBhcmVudDogb2JqZWN0KSB7XG4gIGxldCBhc3NvY2lhdGVkID0gTElOS0VELmdldChwYXJlbnQpO1xuXG4gIGlmIChhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZC5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaXRlbVtESURfRFJPUF0oKTtcbiAgICAgIGFzc29jaWF0ZWQhLmRlbGV0ZShpdGVtKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJ1Y3Rvcih2YWx1ZTogb2JqZWN0KTogRHJvcCB7XG4gIGxldCBkID0gREVTVFJVQ1RPUlMuZ2V0KHZhbHVlKTtcblxuICBpZiAoIWQpIHtcbiAgICBpZiAoaXNEZXN0cm95YWJsZSh2YWx1ZSkpIHtcbiAgICAgIGQgPSBuZXcgRGVzdHJveWFibGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nRGVzdHJveWFibGUodmFsdWUpKSB7XG4gICAgICBkID0gbmV3IFN0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGQgPSBuZXcgU2ltcGxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfVxuXG4gICAgREVTVFJVQ1RPUlMuc2V0KHZhbHVlLCBkKTtcbiAgfVxuXG4gIHJldHVybiBkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc25hcHNob3QodmFsdWVzOiBTZXQ8RHJvcD4pOiBEcm9wIHtcbiAgcmV0dXJuIG5ldyBTbmFwc2hvdERlc3RydWN0b3IodmFsdWVzKTtcbn1cblxuY2xhc3MgU25hcHNob3REZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGVzdHJ1Y3RvcnM6IFNldDxEcm9wPikge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB0aGlzLmRlc3RydWN0b3JzLmZvckVhY2goaXRlbSA9PiBpdGVtW1dJTExfRFJPUF0oKSk7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuZGVzdHJ1Y3RvcnMuZm9yRWFjaChpdGVtID0+IGl0ZW1bRElEX0RST1BdKCkpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiB0aGlzLmRlc3RydWN0b3JzO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTbmFwc2hvdERlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIERlc3Ryb3lhYmxlRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBTeW1ib2xEZXN0cm95YWJsZSkge31cblxuICBbV0lMTF9EUk9QXSgpIHtcbiAgICB3aWxsRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBbRElEX0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXJbREVTVFJPWV0oKTtcbiAgICBkaWREZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnRGVzdHJveWFibGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogRGVzdHJveWFibGUpIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLmlubmVyLndpbGxEZXN0cm95ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLmlubmVyLndpbGxEZXN0cm95KCk7XG4gICAgfVxuICAgIHdpbGxEZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lci5kZXN0cm95KCk7XG4gICAgZGlkRGVzdHJveUFzc29jaWF0ZWQodGhpcy5pbm5lcik7XG4gIH1cblxuICBnZXQgW0NISUxEUkVOXSgpOiBJdGVyYWJsZTxEcm9wPiB7XG4gICAgcmV0dXJuIExJTktFRC5nZXQodGhpcy5pbm5lcikgfHwgW107XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ1N0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuY2xhc3MgU2ltcGxlRGVzdHJ1Y3RvciBpbXBsZW1lbnRzIERyb3Age1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyOiBvYmplY3QpIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgd2lsbERlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgW0RJRF9EUk9QXSgpIHtcbiAgICBkaWREZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU2ltcGxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIExpc3RDb250ZW50c0Rlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogTGlua2VkTGlzdDxMaW5rZWRMaXN0Tm9kZT4pIHt9XG5cbiAgW1dJTExfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lci5mb3JFYWNoTm9kZShkID0+IGRlc3RydWN0b3IoZClbV0lMTF9EUk9QXSgpKTtcbiAgfVxuXG4gIFtESURfRFJPUF0oKSB7XG4gICAgdGhpcy5pbm5lci5mb3JFYWNoTm9kZShkID0+IGRlc3RydWN0b3IoZClbRElEX0RST1BdKCkpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIGxldCBvdXQ6IERyb3BbXSA9IFtdO1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBvdXQucHVzaCguLi5kZXN0cnVjdG9yKGQpW0NISUxEUkVOXSkpO1xuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ0xpc3RDb250ZW50c0Rlc3RydWN0b3InO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVidWdOb2RlIHtcbiAgaW5uZXI6IG9iamVjdDtcbiAgY2hpbGRyZW46IERlYnVnTm9kZVtdIHwgbnVsbDtcbiAgaGFzRHJvcDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYnVnRHJvcFRyZWUoaW5uZXI6IG9iamVjdCk6IERlYnVnTm9kZSB7XG4gIGxldCBoYXNEcm9wID0gaXNEcm9wKGlubmVyKTtcbiAgbGV0IHJhd0NoaWxkcmVuID0gTElOS0VELmdldChpbm5lcikgfHwgbnVsbDtcbiAgbGV0IGNoaWxkcmVuOiBEZWJ1Z05vZGVbXSB8IG51bGwgPSBudWxsO1xuXG4gIGlmIChyYXdDaGlsZHJlbikge1xuICAgIGNoaWxkcmVuID0gW107XG4gICAgZm9yIChsZXQgY2hpbGQgb2YgcmF3Q2hpbGRyZW4pIHtcbiAgICAgIGNoaWxkcmVuLnB1c2goZGVidWdEcm9wVHJlZShjaGlsZCkpO1xuICAgIH1cbiAgfVxuXG4gIGxldCBvYmogPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICBvYmouaW5uZXIgPSBpbm5lcjtcbiAgaWYgKGNoaWxkcmVuKSB7XG4gICAgb2JqLmNoaWxkcmVuID0gY2hpbGRyZW47XG4gIH1cbiAgb2JqLmhhc0Ryb3AgPSBoYXNEcm9wO1xuICByZXR1cm4gb2JqO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnREcm9wVHJlZShpbm5lcjogb2JqZWN0KSB7XG4gIHByaW50RHJvcChkZXN0cnVjdG9yKGlubmVyKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludERyb3AoaW5uZXI6IERyb3ApIHtcbiAgY29uc29sZS5ncm91cChTdHJpbmcoaW5uZXIpKTtcblxuICBjb25zb2xlLmxvZyhpbm5lcik7XG5cbiAgbGV0IGNoaWxkcmVuID0gaW5uZXJbQ0hJTERSRU5dIHx8IG51bGw7XG4gIGlmIChjaGlsZHJlbikge1xuICAgIGZvciAobGV0IGNoaWxkIG9mIGNoaWxkcmVuKSB7XG4gICAgICBwcmludERyb3AoY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbn1cblxuaWYgKExPQ0FMX0RFQlVHICYmIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7XG4gICh3aW5kb3cgYXMgYW55KS5QUklOVF9EUk9QID0gcHJpbnREcm9wVHJlZTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=